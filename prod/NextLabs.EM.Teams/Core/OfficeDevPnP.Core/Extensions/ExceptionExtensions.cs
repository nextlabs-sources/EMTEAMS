using Microsoft.SharePoint.Client;
using System;
using System.Collections;
using System.Collections.Generic;
using System.Linq;
using System.Reflection;
using System.Text;
using System.Threading.Tasks;

namespace System
{
    /// <summary>
    /// Extension methods to get complete exception details and to deal with exceptions easily.
    /// </summary>
    public static class ExceptionExtensions
    {
        /// <summary>
        /// Returns the detailed exception
        /// </summary>
        /// <param name="exception">Exception object</param>
        /// <returns>Returns exception as a string</returns>
        public static string ToDetailedString(this Exception exception)
        {
            if (exception == null)
            {
                throw new ArgumentNullException(nameof(exception));
            }

            return ToDetailedString(exception, ExceptionOptions.Default);
        }

        /// <summary>
        /// Returns exception for the given ClientRunTimeContext
        /// </summary>
        /// <param name="exception">Exception object</param>
        /// <param name="cc">ClientRuntimeContext object</param>
        /// <returns>Returns exception as a string</returns>
        public static string ToDetailedString(this Exception exception, ClientRuntimeContext cc)
        {
            if (exception == null)
            {
                throw new ArgumentNullException(nameof(exception));
            }

            return ToDetailedString(exception, cc, ExceptionOptions.Default);
        }

        /// <summary>
        /// Returns Exception based on ExceptionOptions object
        /// </summary>
        /// <param name="exception">Exception object</param>
        /// <param name="options">ExceptionOptions object</param>
        /// <returns>Returns exception as a string</returns>
        public static string ToDetailedString(this Exception exception, ExceptionOptions options)
        {
            if (exception == null)
            {
                throw new ArgumentNullException(nameof(exception));
            }

            return ToDetailedString(exception, null, ExceptionOptions.Default);
        }

        /// <summary>
        /// Returns exception based on ClientRunTimeContext and ExceptionOptions objects
        /// </summary>
        /// <param name="exception">Exception object</param>
        /// <param name="cc">ClientRuntimeContext object</param>
        /// <param name="options">ExceptionOptions object</param>
        /// <returns>Returns exception as a string</returns>
        public static string ToDetailedString(this Exception exception, ClientRuntimeContext cc, ExceptionOptions options)
        {
            if (exception == null)
            {
                throw new ArgumentNullException(nameof(exception));
            }

            var stringBuilder = new StringBuilder();

            AppendValue(stringBuilder, "Type", exception.GetType().FullName, options);

            if (cc != null && !String.IsNullOrEmpty(cc.TraceCorrelationId))
            {
                AppendValue(stringBuilder, "TraceCorrelationId", cc.TraceCorrelationId, options);
            }

            foreach (PropertyInfo property in exception
                .GetType()
                .GetProperties()
                .OrderByDescending(x => string.Equals(x.Name, nameof(exception.Message), StringComparison.Ordinal))
                .ThenByDescending(x => string.Equals(x.Name, nameof(exception.Source), StringComparison.Ordinal))
                .ThenBy(x => string.Equals(x.Name, nameof(exception.InnerException), StringComparison.Ordinal))
                .ThenBy(x => string.Equals(x.Name, nameof(AggregateException.InnerExceptions), StringComparison.Ordinal)))
            {
                var value = property.GetValue(exception, null);
                if (value == null && options.OmitNullProperties)
                {
                    if (options.OmitNullProperties)
                    {
                        continue;
                    }
                    else
                    {
                        value = string.Empty;
                    }
                }

                AppendValue(stringBuilder, property.Name, value, options);
            }

            return stringBuilder.ToString().TrimEnd('\r', '\n');
        }

        private static void AppendCollection(
            StringBuilder stringBuilder,
            string propertyName,
            IEnumerable collection,
            ExceptionOptions options)
        {
            stringBuilder.AppendLine($"{options.Indent}{propertyName} =");

            var innerOptions = new ExceptionOptions(options, options.CurrentIndentLevel + 1);

            var i = 0;
            foreach (var item in collection)
            {
                var innerPropertyName = $"[{i}]";

                if (item is Exception)
                {
                    var innerException = (Exception)item;
                    AppendException(
                        stringBuilder,
                        innerPropertyName,
                        innerException,
                        innerOptions);
                }
                else
                {
                    AppendValue(
                        stringBuilder,
                        innerPropertyName,
                        item,
                        innerOptions);
                }

                ++i;
            }
        }

        private static void AppendException(
            StringBuilder stringBuilder,
            string propertyName,
            Exception exception,
            ExceptionOptions options)
        {
            var innerExceptionString = ToDetailedString(
                exception,
                new ExceptionOptions(options, options.CurrentIndentLevel + 1));

            stringBuilder.AppendLine($"{options.Indent}{propertyName} =");
            stringBuilder.AppendLine(innerExceptionString);
        }

        private static string IndentString(string value, ExceptionOptions options)
        {
            return value.Replace(Environment.NewLine, Environment.NewLine + options.Indent);
        }

        private static void AppendValue(
            StringBuilder stringBuilder,
            string propertyName,
            object value,
            ExceptionOptions options)
        {
            if (value is DictionaryEntry)
            {
                DictionaryEntry dictionaryEntry = (DictionaryEntry)value;
                stringBuilder.AppendLine($"{options.Indent}{propertyName} = {dictionaryEntry.Key} : {dictionaryEntry.Value}");
            }
            else if (value is Exception)
            {
                var innerException = (Exception)value;
                AppendException(
                    stringBuilder,
                    propertyName,
                    innerException,
                    options);
            }
            else if (value is IEnumerable && !(value is string))
            {
                var collection = (IEnumerable)value;
                if (collection.GetEnumerator().MoveNext())
                {
                    AppendCollection(
                        stringBuilder,
                        propertyName,
                        collection,
                        options);
                }
            }
            else
            {
                stringBuilder.AppendLine($"{options.Indent}{propertyName} = {value}");
            }
        }
    }

    /// <summary>
    /// Holds options for Exception
    /// </summary>
    public struct ExceptionOptions
    {
        public static readonly ExceptionOptions Default = new ExceptionOptions()
        {
            CurrentIndentLevel = 0,
            IndentSpaces = 4,
            OmitNullProperties = true
        };

        internal ExceptionOptions(ExceptionOptions options, int currentIndent)
        {
            this.CurrentIndentLevel = currentIndent;
            this.IndentSpaces = options.IndentSpaces;
            this.OmitNullProperties = options.OmitNullProperties;
        }

        internal string Indent { get { return new string(' ', this.IndentSpaces * this.CurrentIndentLevel); } }

        internal int CurrentIndentLevel { get; set; }

        /// <summary>
        /// Gets or sets the integer value for space indentation
        /// </summary>
        public int IndentSpaces { get; set; }
        /// <summary>
        /// Gets or sets the OmitNullProperties flag
        /// </summary>
        public bool OmitNullProperties { get; set; }
    }
}
